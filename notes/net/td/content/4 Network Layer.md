# 网络层概述
1. 网络层目标: 实现主机和主机之间通. 运输层实现进程到进程的通信
2. 分组交换机的分类
    1. 根据链路层首部信息进行转发的——链路层节点交换机
    2. 根据网络层首部信息进行转发的——路由器
3. 网络层可能提供的服务
    1. 确保交付
    2. 具有时延上界的确保交付
    3. 有序分组交付
    4. 确保最小带宽
    5. 确保最大时延抖动
4. 网络层提供的服务
    1. 面向连接的服务——虚电路，需事先握手
    2. 面向无连接的服务——数据报，无需握手
## 虚电路和数据报网络
### 虚电路
1. 虚电路的组成
    1. 从源到目的主机的路径
    2. VC 号, 沿着该路径的每段链路的一个号码
    3. 沿着该路径的每台路由器中的转发表
### 数据报网络
1. 数据报网络
    1. 在网络层没有连接建立过程
    2. 路由器：在端到端的连接中不维护连接状态信息
    3. 传输报文时使用目的主机地址信息
## 路由器的工作原理
1. 输入端口排队
    1. 经内存交换
    2. 经总线交换
    3. 经内联网络

2. 输出端口排队: 当通过交换结构到达的分组速率超过了输出链路的速率时，需要对分组进行缓存 

## 网际协议:因特网中的转发和编址
1. IP重组
    1. 网络链路具有 MTU (最大传输单位)属性——是由链路层最大帧的限制决定的,不同类型的链路有不同的MTU值
    2. 大的IP数据报在网络中会被分成小的分片
        1. 一个数据报变成了几个数据报
        2. 重组只在目的主机进行
        3. 数据报头部的标识、标志以及片偏移字段用于目的主机对接收的分片进行重组
 
2. IP结构 : 网络号 + 主机号
3. 子网划分:
    1. 从主机号中间借用一部分数值作为子网号
    2. 子网掩码: 网络号和子网号 设置为1 , 其余为0
    3. 网络地址: ip and 子网掩码

4. IP地址的扩展——构造超网 **PPT** 似乎没有讲清楚

5. CIDR Classless InterDomain Routing **似乎有什么的没有讲清楚**

6. DHCP
    1. DHCP 协议并不仅仅只能获取 IP 地址 而且可以得到,网关地址 DNS地址 子网掩码

7. NAT
    1. 动机
    2. 实现
    3. 三种地址转化方法:
        1. 静态NAT：一个本地地址对应一个全球地址
        1. 动态NAT：一个全球地址对应多个本地地址
        1. 端口NAT：一个本地地址的端口对应到一个全球地址的端口
    4. NAT 的问题:
        

    
## 选路算法
1. 概念
    1. 默认路由器：一台主机“直接”连接到的路由器
    2. 源路由器：源主机的默认路由器
    3. 目的路由器：目标主机的默认路由器

2. 选路算法分类:
    1. 全局选路算法: 链路状态算法
    2. 分散式选路算法: 距离向量算法

    1. 静态选路算法
    2. 动态选路算法

    1. 负载敏感算法
    2. 负载迟钝算法

3. 链路状态选路算法
    1. 通过链路状态广播获得信息
    2. 为该节点提供转发表
    3. 问题: **PPT 397**

4. OSPF:
    1. 分布式的链路状态协议
    2. 要点
        1. 向本自治系统中所有路由器发送信息，使用的方法是洪泛法
        2. 发送的信息就是与本路由器相邻的所有路由器的链路状态
        3. 只有当链路状态发生变化时，路由器才用洪泛法向所有路由器发送此信息  
    3. 内容
        1. 不强制如何设置链路权值的策略，但提供对给定链路权值集合确定最低费用路径的机制
        2. 即使链路状态未发生变化，每30分钟广播一次链路状态
        3. 链路状态以OSPF通告的形式封装在 OSPF 报文中，由IP分组承载（协议号：89）
        4. SPF路由器之间的交换都是经过鉴别的（简单的、MD5的），以确认OSPF通告的真实性，防止伪造和篡改
        2. OSPF通告都是有序列号的，以防止重放攻击
        2. OSPF中支持多条具有相同费用的路径
        2. OSPF支持多播选路和层次路由

5. 距离向量选路算法
    1. 迭代、分布、自我终止、异步
    2. 思想:
        1. 使用Bellman-Ford 公式
        2. 每个路由器中都有一张路由表，包含三个内容：目的网络号、经过的邻居路由器、距离
        3. 路由器定期向其邻居路由器传送路由表的拷贝
    3. 更新算法(Bellman-Ford):
        1. 路由器`X`得到相邻路由器`Y`的路由表，从而得知：`Y`到网络`Z`的最短距离为 N
        2. 如果路由器`X`没有到网络`Z`的路由条目，则添加一条经由路由器`Y`到网络`Z`距离 N+1的路由条目
        3. 如果路由器`X`已有到网络Z的路由条目，其距离为M，如果M> N+1，则更新该条目为经由路由器`Y`到网络`Z`距离N+1，否则不更新

    4. **无穷计数**


6. 因特网上的距离向量算法——RIP协议
    1. 相邻两点间链路上的费用定义为1，即只考虑源到目标经过多少个路由器，或多少“跳”
    2. 一条路径的最大费用限制为15
    3. 选路更新消息每30s 在邻居之间以 RIP 响应报文（RIP通告）的形式进行交换
    4. 路由器经过180s 没有收到来自某个邻居的 RIP 通告，则认为该邻居已离线，修改选路表，向其它邻居广播
    5. RIP 是一个运行在 UDP 上的应用层协议（端口520）

7. 层次路由
    1. 将路由器聚合到一个区域, “自治系统” (AS) 相同AS所有路由器上面使用相同 IGP, 不同AS 可以使用不同的
    2. 转发表是由 AS 内部选路算法和 AS 间选路算法共同决定的
    3. 热土豆算法: 选择费用最低的网关

8. 因特网上的AS内层次路由——层次OSPF
    1. 为了使 OSPF 能够用于规模很大的网络，OSPF 将一个自治系统再划分为若干个更小的范围，叫作区域
    2. 每一个区域都有一个 32 bit 的区域标识符
    3. 区域也不能太大，在一个区域内的路由器最好不超过 200 个 
    4. 划分区域
        1. 划分区域的好处就是将利用洪泛法交换链路状态信息的范围局限于每一个区域而不是整个的自治系统，这就减少了整个网络上的通信量。
        2. 在一个区域内部的路由器只知道本区域的完整网络拓扑，而不知道其他区域的网络拓扑的情况。
        3. OSPF 使用层次结构的区域划分。在上层的区域叫作主干区域(backbone area)。主干区域的标识符规定为0.0.0.0。主干区域的作用是用来连通其他在下层的区域。

9. 因特网上的AS间路由——BGP
    1. BGP
        1. 从相邻AS获取子网可达性信息
        2. 向该AS内部的所有路由器传播这些可达性信息
        3. 基于该可达性信息和AS策略，决定到达子网的“好”路由
            1. 边界网关协议 BGP 只能是力求寻找一条能够到达目的网络且比较好的路由（不能兜圈子），而并非要寻找一条最佳路由
    2. BGP发言人: 每一个自治系统的管理员要选择至少一个路由器作为该自治系统的“BGP 发言人”
        1. 一个 BGP 发言人与其他自治系统中的 BGP 发言人要交换路由信息，就要先建立 TCP 连接，然后在此连接上交换 BGP 报文以建立 BGP 会话(session)，利用 BGP 会话交换路由信息。
        2. 使用 TCP 连接能提供可靠的服务，也简化了路由选择协议。
        3. 使用 TCP 连接交换路由信息的两个 BGP 发言人，彼此成为对方的邻站或对等站。

    3. BGP路由通告
        1. AS2可以聚合多个前缀为一个，并使用 BGP 向AS1通告单一前缀，则 AS2承诺它将沿着朝向该前缀的路径，转发指向该前缀的任何数据报

    4. **BGP** 不是很清楚 **前缀** **进入表项**
    
10. 表项如何进入路由转发表中间 **A**


11. 路由协议小结 => **too much**
    1. 协议类型 : **IGP** 
    2. 信息表达格式：　**路径向量**
    3. 


 

## IP组播介绍
组播: 将数据分发给网络中处于同一个组的多台主机上的应用进程


## 问题
1. CPT实验问题
    1. 不同子网之间, 中间含有路由器, 各自配置了网管, 是否可以通信, 如果中间没有路由器, 是否可以通信 ?
    2. 什么是否需要查询网关
    3. 不设置 VLAN, 不设置RIP的时候, 什么时候无法实现通信

2. PPT  36页, 为什么上面两个 frame 是 2 个长度
3. 网络号 主机号定义是什么 ? 
4. 默认路由器 55ppt 为给出默认路由器, 想要表达什么 ?
5. 网络前缀 和 网络号 分别是什么 ?
6. 网络地址 是什么







路由器的结构
1. 输入端口
2. 输出端口
    1. 缓存管理
    2. 调度原则
        1. 先来先服务 FCFS
        2. 加权公平排队 WEQ
    3. 分组丢弃策略
        1. 被动
            1. 弃尾
            2. 同时删除
        2. 主动, 随机早期检测RED
            1. 按照概率丢弃
3. 交换结构
    1. memory: cpu的控制
    2. bus
    3. crossbar


因特网中的转发和编址
IP 协议
ip 数据包的格式:
1. 版本 首部长度 服务类型 总长度
2. 标识 标志 片偏移
3. 生存时间(跳) 协议(TCP / UDP) 首部检查和
4. 源地址
5. 目标地址



ip 地址:
1. 网络分类
2. 网络地址: 仅仅路由表 转发表 , 广播地址: 不可以源地址, 但是可以目标地址
3. 同一个局域网上面的网络号相同
4. 路由器的每一个接口都有不同网络号的IP 地址

子网的划分: 从主机号中间借用一部分作为子网号


1. ip的网络号是否为本网络的网络号
2. 网络号为本网络号的时候, 

1. ip地址的扩展 -> 构造超网 :需要相邻的




1. 网络地址 网络号 子网号
2. CIDR(classless inter Domain Routing)
    1. ip 地址{网络前缀 + 主机号}
    2. 网际协议:英特网的转发和编址
    3. ISP 获取整块地址: ICANN 分配
    4. 主机获取ip: 手动配置 或者 DHCP动态分配
    5. NAT
        1. 三种对应的方式: 动态分配 静态分配 端口映射
    6. UPnP
    7. 中继
    8. ICMP  


选路算法:
默认路由器
源路由器
目标路由器   
